

sudo apt-get update
sudo apt-get upgrade -y

Instale os pacotes do LDAP:

sudo apt-get install slapd ldap-utils

2. Configuração

Remova o diretório com a configuração padrão e base padão que foi criada:

sudo rm -rf /etc/ldap/slapd.d/
sudo rm /var/lib/ldap/*

Agora entre no arquivo /etc/default/slapd e edite a linha "SLAPD_CONF=" adicionando o caminho do novo arquivo de configuração do slapd.

SLAPD_CONF="/etc/ldap/slapd.conf"

No mesmo arquivo edite a linha SLAPD_SERVICES= e adicione a opção ldaps:/// para utilizat o LDAPS, a linha irá ficar assim:

SLAPD_SERVICES="ldap:/// ldapi:/// ldaps:///"

Salve e saia do arquivo.

Crie o arquivo de configuração slapd.conf, com as seguintes configurações do ldap de produção.
OBS: Se preferir pode pegar o backup do arquivo que está em produção e adicionar no novo arquivo, alterando apenas a chave e o certificado que será criado.

vi /etc/ldap/slapd.conf

##### Arquivo de configuração

include         /etc/ldap/schema/core.schema
include         /etc/ldap/schema/cosine.schema
include         /etc/ldap/schema/nis.schema
include         /etc/ldap/schema/inetorgperson.schema
include         /etc/ldap/schema/postfix.schema    # não vem na instalação padrão, pegar schema do servidor de produção
include         /etc/ldap/schema/sudoers.schema    # não vem na instalação padrão, pegar schema do servidor de produção
include         /etc/ldap/schema/ppolicy.schema


pidfile         /var/run/slapd/slapd.pid
argsfile        /var/run/slapd/slapd.args

moduleload      back_hdb.la
moduleload      ppolicy.la
moduleload      lastbind.la
moduleload      syncprov.la                        #Módulo utilizado para fazer a replicação

#logfile                /var/log/openldap/openldap.log
#loglevel       -1


database        hdb
suffix  "dc=in,dc=iti,dc=br"
rootdn  "cn=admin,dc=in,dc=iti,dc=br"
rootpw  $password

overlay ppolicy
ppolicy_default "cn=ppolicyDefault,ou=policies,dc=in,dc=iti,dc=br"

overlay lastbind
lastbind-precision 480

directory       /var/lib/ldap
index   objectClass     eq
index   uid             eq
index   uidNumber,gidNumber eq
index   cn,sn           eq
index   mail            eq
index   memberUid       eq
index   sudoUser        eq

TLSCACertificateFile /etc/ldap/
TLSCertificateFile /etc/ldap/ldap01_slapd_cert.pem    ##Deverá ser gerado um novo certificado
TLSCertificateKeyFile /etc/ldap/ldap01_slapd_key.pem    ##Deverá ser gerado uma nova chave
security tls=0 ssf=0 simple_bind=0
TLSVerifyClient try


overlay syncprov                  ##Configuração syncprov necessária para fazer replicação
syncprov-checkpoint 100 10
syncprov-sessionlog 100


access to attrs=userPassword
  by dn="cn=replica,dc=in,dc=iti,dc=br"      ##Necessário apenas para fazer replicação
  by self write
  by anonymous auth
  by users none

access to *
  by dn="cn=replica,dc=in,dc=iti,dc=br"      ##Necessário apenas para fazer replicação
  by self write
  by anonymous read
  by * search

Crie um arquivo chamado dominio.ldif com as informações iniciais para criar o domínio.

dn: dc=in,dc=iti,dc=br
objectClass: top
objectClass: dcObject
objectClass: organization
o: iti

dn: ou=People,dc=in,dc=iti,dc=br
objectClass: organizationalUnit
ou: People

dn: ou=Groups,dc=in,dc=iti,dc=br
objectClass: organizationalUnit
ou: Groups

Use o ldapadd para criar o domínio com as OU People e Groups com o comando abaixo:

ldapadd -x -D cn=admin,dc=in,dc=iti,dc=br -w $Password -H ldap://localhost -f dominio.ldif

Após isso pode iniciar o serviço do LDAP:

sudo systemctl start slapd

























4. Instalação phpldapadmin

Instale o pacote com o comando abaixo:

sudo apt-get install phpldapadmin

Edite o arquivo /etc/phpldapadmin/config.php para fazer a configuração do phpldapadmin:

vi /etc/phpldapadmin/config.php

Edite as seguintes linhas conforme mostrado abaixo:

$servers->setValue('server','name','ldap-itibr');

$servers->setValue('server','base',array('dc=in,dc=iti,dc=br'));

$servers->setValue('login','bind_id','cn=admin,dc=in,dc=iti,dc=br');

$servers->setValue('login','bind_pass','$password');

$servers->setValue('appearance','password_hash_custom','sha');

$servers->setValue('auto_number','min',array('uidNumber'=>11000,'gidNumber'=>100));

Reinicie o serviço.

sudo systemctl restart slapd
